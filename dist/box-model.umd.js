!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((t||self).boxModel={})}(this,function(t){function n(){return(n=Object.assign||function(t){for(var n=1;n<arguments.length;n++){var r=arguments[n];for(var e in r)Object.prototype.hasOwnProperty.call(r,e)&&(t[e]=r[e])}return t}).apply(this,arguments)}function r(t,n,r,e){for(var i=t.length,o=e(t,n),s=new Array(i),u=r/2,a=r/6,c=n+u,f=0;f<i;f+=1)s[f]=t[f]+u*o[f];for(var p=e(s,c),d=0;d<i;d+=1)s[d]=t[d]+u*p[d];for(var h=e(s,c),l=0;l<i;l+=1)s[l]=t[l]+r*h[l],h[l]+=p[l];return p=e(s,n+r),t.map(function(n,r){return t[r]+a*(o[r]+p[r]+2*h[r])})}t.BoxModel=function(){function t(e,i){var o=e.stocks,s=e.flows,u=e.variables,a=e.constants;void 0===i&&(i=r),this.stocks=o,this.flows=s,this.variables=u,this.constants=a,this.integrator=i,this.ensureUniqueIds(),this.idToIdx=n({},t.createIdToIdxMap(o),t.createIdToIdxMap(u),t.createIdToIdxMap(a),t.createIdToIdxMap(s))}var e=t.prototype;return e.ensureUniqueIds=function(){var t=[].concat(this.stocks,this.variables,this.constants,this.flows).map(function(t){return t.id}).reduce(function(t,n,r,e){return e.lastIndexOf(n)!==r&&e.push(n),t},[]);if(t.length>0)throw new Error("Duplicate ids found: "+JSON.stringify(t))},t.createIdToIdxMap=function(t){return t.reduce(function(t,n,r){var e;return Object.assign(t,((e={})[n.id]=r,e))},{})},e.evaluateGraph=function(t,n){var r,e,i=this,o=function(n){return t[i.idToIdx[n]]},s=this.constants.map(function(t){return t.value}),u=function(t){return s[i.idToIdx[t]]},a=function(t){var s=new Array(t.length),a=function(a){var c=i.idToIdx[a];if(null===s[c])throw new Error("Evaluation cycle detected starting at: "+a);return void 0===s[c]&&(s[c]=null,s[c]=t[c].equation(o,r,e,u,n)),s[c]};return a.data=s,a},c=(e=a(this.variables)).data,f=(r=a(this.flows)).data;return this.variables.forEach(function(t){return e(t.id)}),this.flows.forEach(function(t){return r(t.id)}),{stocks:t,flows:f,variables:c,constants:s,t:n}},e.step=function(t,n,r,e){return"number"==typeof n?this.step3(t,n,r):this.step4(t,n,r,e)},e.step3=function(t,n,r){var e=this;return this.stepImpl(t,function(t,n){return e.evaluateGraph(t,n).flows},n,r)},e.step4=function(t,n,r,e){var i=this;return this.stepImpl(t,function(t,e){return e===r?n:i.evaluateGraph(t,e).flows},r,e)},e.stepImpl=function(t,n,r,e){var i=this;return this.integrator(t,r,e,function(t,r){var e=n(t,r),o=function(t){return e[i.idToIdx[t]]},s=function(t){return t.map(o).reduce(function(t,n){return t+n},0)};return i.stocks.map(function(t){return s(t.in)-s(t.out)})})},e.stepExt=function(t,n,r,e){return"number"==typeof n?this.stepExt3(t,n,r):this.stepExt4(t,n,r,e)},e.stepExt3=function(t,r,e){var i=this.step(t,r,e);return n({stocks:i},this.evaluateGraph(i,r+e))},e.stepExt4=function(t,r,e,i){var o=this.step(t,r,e,i);return n({stocks:o},this.evaluateGraph(o,e+i))},t}(),t.euler=function(t,n,r,e){var i=e(t,n);return t.map(function(t,n){return t+r*i[n]})},t.rk4=r});
//# sourceMappingURL=box-model.umd.js.map
