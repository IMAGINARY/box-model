!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((t||self).boxModel={})}(this,function(t){function r(){return(r=Object.assign||function(t){for(var r=1;r<arguments.length;r++){var e=arguments[r];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])}return t}).apply(this,arguments)}function e(t,r,e,n){for(var i=t.length,o=n(t,r),a=new Array(i),s=e/2,u=e/6,f=r+s,c=0;c<i;c+=1)a[c]=t[c]+s*o[c];for(var p=n(a,f),d=0;d<i;d+=1)a[d]=t[d]+s*p[d];for(var h=n(a,f),l=0;l<i;l+=1)a[l]=t[l]+e*h[l],h[l]+=p[l];return p=n(a,r+e),t.map(function(r,e){return t[e]+u*(o[e]+p[e]+2*h[e])})}t.BoxModel=function(){function t(n,i){var o=n.stocks,a=n.flows,s=n.variables,u=n.parameters;void 0===i&&(i=e),this.stocks=o,this.flows=a,this.variables=s,this.parameters=u,this.integrator=i,this.ensureUniqueIds(),this.idToIdx=r({},t.createIdToIdxMap(o),t.createIdToIdxMap(s),t.createIdToIdxMap(u),t.createIdToIdxMap(a))}var n=t.prototype;return n.ensureUniqueIds=function(){var t=[].concat(this.stocks,this.variables,this.parameters,this.flows).map(function(t){return t.id}).reduce(function(t,r,e,n){return n.lastIndexOf(r)!==e&&n.push(r),t},[]);if(t.length>0)throw new Error("Duplicate ids found: "+JSON.stringify(t))},t.createIdToIdxMap=function(t){return t.reduce(function(t,r,e){var n;return Object.assign(t,((n={})[r.id]=e,n))},{})},n.evaluateGraph=function(t,r){var e,n,i=this,o=function(r){return t[i.idToIdx[r]]},a=this.parameters.map(function(t){return t.value}),s=function(t){return a[i.idToIdx[t]]},u=function(t){var a=new Array(t.length),u=function(u){var f=i.idToIdx[u];if(null===a[f])throw new Error("Evaluation cycle detected starting at: "+u);return void 0===a[f]&&(a[f]=null,a[f]=t[f].formula(o,e,n,s,r)),a[f]};return u.data=a,u},f=(n=u(this.variables)).data,c=(e=u(this.flows)).data;return this.variables.forEach(function(t){return n(t.id)}),this.flows.forEach(function(t){return e(t.id)}),{stocks:t,flows:c,variables:f,parameters:a,t:r}},n.step=function(t,r,e,n){return"number"==typeof r?this.step3(t,r,e):this.step4(t,r,e,n)},n.step3=function(t,r,e){var n=this;return this.stepImpl(t,function(t,r){return n.evaluateGraph(t,r).flows},r,e)},n.step4=function(t,r,e,n){var i=this;return this.stepImpl(t,function(t,n){return n===e?r:i.evaluateGraph(t,n).flows},e,n)},n.stepImpl=function(t,r,e,n){var i=this;return this.integrator(t,e,n,function(t,e){var n=r(t,e),o=function(t){return n[i.idToIdx[t]]},a=function(t){return t.map(o).reduce(function(t,r){return t+r},0)};return i.stocks.map(function(t){return a(t.in)-a(t.out)})})},n.stepExt=function(t,r,e,n){return"number"==typeof r?this.stepExt3(t,r,e):this.stepExt4(t,r,e,n)},n.stepExt3=function(t,e,n){var i=this.step(t,e,n);return r({stocks:i},this.evaluateGraph(i,e+n))},n.stepExt4=function(t,e,n,i){var o=this.step(t,e,n,i);return r({stocks:o},this.evaluateGraph(o,n+i))},t}(),t.euler=function(t,r,e,n){var i=n(t,r);return t.map(function(t,r){return t+e*i[r]})},t.rk4=e});
//# sourceMappingURL=box-model.umd.js.map
