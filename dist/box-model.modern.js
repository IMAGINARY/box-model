function t(t,e,r,s){const a=s(t,e);return t.map((t,e)=>t+r*a[e])}function e(t,e,r,s){const a=t.length,o=s(t,e),n=new Array(a),i=r/2,p=r/6,l=e+i;for(let e=0;e<a;e+=1)n[e]=t[e]+i*o[e];let h=s(n,l);for(let e=0;e<a;e+=1)n[e]=t[e]+i*h[e];const c=s(n,l);for(let e=0;e<a;e+=1)n[e]=t[e]+r*c[e],c[e]+=h[e];return h=s(n,e+r),t.map((e,r)=>t[r]+p*(o[r]+h[r]+2*c[r]))}class r{constructor(t,r={integrator:e}){this.model=t,this.integrator=r.integrator}static createIdToIdxMap(t){return t.reduce((t,{id:e},r)=>Object.assign(t,{[e]:r}),{})}evaluateGraph(t,e){const s=r.createIdToIdxMap(this.model.stocks),a=e=>t[s[e]],o=r.createIdToIdxMap(this.model.parameters),n=this.model.parameters.map(({value:t})=>t),i=t=>n[o[t]];let p,l;const h=t=>{const s=r.createIdToIdxMap(t),o=t.map(()=>!1),n=r=>{const n=s[r];if("boolean"==typeof o[n]){if(o[n])throw new Error(`Evaluation cycle detected starting at: ${r}`);return o[n]=!0,o[n]=t[n].formula(a,p,l,i,e),o[n]}return o[n]};return n.data=o,n};return l=h(this.model.variables),p=h(this.model.flows),this.model.variables.forEach(({id:t})=>l(t)),this.model.flows.forEach(({id:t})=>p(t)),{stocks:t,flows:p.data,variables:l.data,parameters:n,t:e}}step(t,e,r,s){if("number"==typeof e)return this.step3(t,e,r);if(void 0!==s)return this.step4(t,e,r,s);throw new SyntaxError}step3(t,e,r){return this.stepImpl(t,(t,e)=>this.evaluateGraph(t,e).flows,e,r)}step4(t,e,r,s){return this.stepImpl(t,(t,s)=>s===r?e:this.evaluateGraph(t,s).flows,r,s)}stepImpl(t,e,s,a){const o=r.createIdToIdxMap(this.model.flows);return this.integrator(t,s,a,(t,r)=>{const s=e(t,r),a=t=>s[o[t]],n=t=>t.map(a).reduce((t,e)=>t+e,0);return this.model.stocks.map(t=>n(t.in)-n(t.out))})}stepExt(t,e,r,s){if("number"==typeof e)return this.stepExt3(t,e,r);if(void 0!==s)return this.stepExt4(t,e,r,s);throw new SyntaxError}stepExt3(t,e,r){const s=this.step(t,e,r);return this.evaluateGraph(s,e+r)}stepExt4(t,e,r,s){const a=this.step(t,e,r,s);return this.evaluateGraph(a,r+s)}}export{r as BoxModelEngine,t as euler,e as rk4};
//# sourceMappingURL=box-model.modern.js.map
