function t(t,e,r,o){const s=o(t,e);return t.map((t,e)=>t+r*s[e])}function e(t,e,r,o){const s=t.length,a=o(t,e),n=new Array(s),i=r/2,p=r/6,l=e+i;for(let e=0;e<s;e+=1)n[e]=t[e]+i*a[e];let u=o(n,l);for(let e=0;e<s;e+=1)n[e]=t[e]+i*u[e];const c=o(n,l);for(let e=0;e<s;e+=1)n[e]=t[e]+r*c[e],c[e]+=u[e];return u=o(n,e+r),t.map((e,r)=>t[r]+p*(a[r]+u[r]+2*c[r]))}const r=Object.prototype.hasOwnProperty;function o(t,e){return r.call(t,e)}function s(t,e){throw new Error(`Value of unknown ${t} requested: ${e}. Check your box model definition.`)}class a{constructor(t,r={integrator:e}){this.model=t,this.integrator=r.integrator}static createIdToIdxMap(t){return t.reduce((t,{id:e},r)=>(t[e]=r,t),{})}evaluateGraph(t,e){const r=a.createIdToIdxMap(this.model.stocks),n=e=>(o(r,e)||s("stock",e),t[r[e]]),i=a.createIdToIdxMap(this.model.parameters),p=this.model.parameters.map(({value:t})=>t),l=t=>(o(i,t)||s("parameter",t),p[i[t]]);let u,c;const h=(t,r)=>{const i=a.createIdToIdxMap(t),p=t.map(()=>!1),h=a=>{o(i,a)||s(r,a);const h=i[a];if("boolean"==typeof p[h]){if(p[h])throw new Error(`Evaluation cycle detected starting at: ${a}`);return p[h]=!0,p[h]=t[h].formula(n,u,c,l,e),p[h]}return p[h]};return h.data=p,h};return c=h(this.model.variables,"variable"),u=h(this.model.flows,"flow"),this.model.variables.forEach(({id:t})=>c(t)),this.model.flows.forEach(({id:t})=>u(t)),{stocks:t,flows:u.data,variables:c.data,parameters:p,t:e}}step(t,e,r,o){if("number"==typeof e)return this.step3(t,e,r);if(void 0!==o)return this.step4(t,e,r,o);throw new TypeError}step3(t,e,r){return this.stepImpl(t,(t,e)=>this.evaluateGraph(t,e).flows,e,r)}step4(t,e,r,o){return this.stepImpl(t,(t,o)=>o===r?e:this.evaluateGraph(t,o).flows,r,o)}stepImpl(t,e,r,o){const s=a.createIdToIdxMap(this.model.flows);return this.integrator(t,r,o,(t,r)=>{const o=e(t,r),a=t=>o[s[t]],n=t=>t.map(a).reduce((t,e)=>t+e,0);return this.model.stocks.map(t=>n(t.in)-n(t.out))})}stepExt(t,e,r,o){if("number"==typeof e)return this.stepExt3(t,e,r);if(void 0!==o)return this.stepExt4(t,e,r,o);throw new TypeError}stepExt3(t,e,r){const o=this.step(t,e,r);return this.evaluateGraph(o,e+r)}stepExt4(t,e,r,o){const s=this.step(t,e,r,o);return this.evaluateGraph(s,r+o)}}export{a as BoxModelEngine,t as euler,e as rk4};
//# sourceMappingURL=box-model.modern.js.map
