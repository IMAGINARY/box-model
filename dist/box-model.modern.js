function t(){return(t=Object.assign||function(t){for(var s=1;s<arguments.length;s++){var e=arguments[s];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])}return t}).apply(this,arguments)}function s(t,s,e,r){const a=r(t,s);return t.map((t,s)=>t+e*a[s])}function e(t,s,e,r){const a=t.length,i=r(t,s),o=new Array(a),n=e/2,h=e/6,p=s+n;for(let s=0;s<a;s+=1)o[s]=t[s]+n*i[s];let c=r(o,p);for(let s=0;s<a;s+=1)o[s]=t[s]+n*c[s];const l=r(o,p);for(let s=0;s<a;s+=1)o[s]=t[s]+e*l[s],l[s]+=c[s];return c=r(o,s+e),t.map((s,e)=>t[e]+h*(i[e]+c[e]+2*l[e]))}class r{constructor({stocks:s,flows:a,variables:i,parameters:o},n=e){this.stocks=s,this.flows=a,this.variables=i,this.parameters=o,this.integrator=n,this.ensureUniqueIds(),this.idToIdx=t({},r.createIdToIdxMap(s),r.createIdToIdxMap(i),r.createIdToIdxMap(o),r.createIdToIdxMap(a))}ensureUniqueIds(){const t=[].concat(this.stocks,this.variables,this.parameters,this.flows).map(t=>t.id).reduce((t,s,e,r)=>(r.lastIndexOf(s)!==e&&r.push(s),t),[]);if(t.length>0)throw new Error(`Duplicate ids found: ${JSON.stringify(t)}`)}static createIdToIdxMap(t){return t.reduce((t,{id:s},e)=>Object.assign(t,{[s]:e}),{})}evaluateGraph(t,s){const e=s=>t[this.idToIdx[s]],r=this.parameters.map(({value:t})=>t),a=t=>r[this.idToIdx[t]];let i,o;const n=t=>{const r=new Array(t.length),n=n=>{const h=this.idToIdx[n];if(null===r[h])throw new Error(`Evaluation cycle detected starting at: ${n}`);return void 0===r[h]&&(r[h]=null,r[h]=t[h].formula(e,i,o,a,s)),r[h]};return n.data=r,n};o=n(this.variables);const h=o.data;i=n(this.flows);const p=i.data;return this.variables.forEach(({id:t})=>o(t)),this.flows.forEach(({id:t})=>i(t)),{stocks:t,flows:p,variables:h,parameters:r,t:s}}step(t,s,e,r){return"number"==typeof s?this.step3(t,s,e):this.step4(t,s,e,r)}step3(t,s,e){return this.stepImpl(t,(t,s)=>this.evaluateGraph(t,s).flows,s,e)}step4(t,s,e,r){return this.stepImpl(t,(t,r)=>r===e?s:this.evaluateGraph(t,r).flows,e,r)}stepImpl(t,s,e,r){return this.integrator(t,e,r,(t,e)=>{const r=s(t,e),a=t=>r[this.idToIdx[t]],i=t=>t.map(a).reduce((t,s)=>t+s,0);return this.stocks.map(t=>i(t.in)-i(t.out))})}stepExt(t,s,e,r){return"number"==typeof s?this.stepExt3(t,s,e):this.stepExt4(t,s,e,r)}stepExt3(s,e,r){const a=this.step(s,e,r);return t({stocks:a},this.evaluateGraph(a,e+r))}stepExt4(s,e,r,a){const i=this.step(s,e,r,a);return t({stocks:i},this.evaluateGraph(i,r+a))}}export{r as BoxModel,s as euler,e as rk4};
//# sourceMappingURL=box-model.modern.js.map
