{"version":3,"file":"box-model.umd.js","sources":["../src/ode.ts","../src/util.ts","../src/box-model.ts"],"sourcesContent":["export function euler(\n  y: ReadonlyArray<number>,\n  x: number,\n  h: number,\n  derivatives: (y: ReadonlyArray<number>, x: number) => number[]\n): number[] {\n  const dydx = derivatives(y, x);\n  return y.map((yi, i) => yi + h * dydx[i]);\n}\n\nexport function rk4(\n  y: ReadonlyArray<number>,\n  x: number,\n  h: number,\n  derivatives: (y: ReadonlyArray<number>, x: number) => number[]\n): number[] {\n  const n: number = y.length;\n\n  const dydx = derivatives(y, x);\n  const yTemp: number[] = new Array(n) as number[];\n\n  const h2 = h / 2.0;\n  const h6 = h / 6.0;\n  const xhh = x + h2;\n\n  for (let i = 0; i < n; i += 1) yTemp[i] = y[i] + h2 * dydx[i];\n  let dydxTemp = derivatives(yTemp, xhh);\n\n  for (let i = 0; i < n; i += 1) yTemp[i] = y[i] + h2 * dydxTemp[i];\n  const dydxM = derivatives(yTemp, xhh);\n\n  for (let i = 0; i < n; i += 1) {\n    yTemp[i] = y[i] + h * dydxM[i];\n    dydxM[i] += dydxTemp[i];\n  }\n  dydxTemp = derivatives(yTemp, x + h);\n\n  return y.map((_, i) => y[i] + h6 * (dydx[i] + dydxTemp[i] + 2.0 * dydxM[i]));\n}\n","export function sum(arr: Array<number>): number {\n  return arr.reduce((acc, cur) => acc + cur, 0);\n}\n\n// eslint-disable-next-line @typescript-eslint/unbound-method\nconst hasOwnPropertyFunc = Object.prototype.hasOwnProperty;\nexport function hasOwnProperty(\n  o: Record<string, unknown>,\n  key: string\n): boolean {\n  return hasOwnPropertyFunc.call(o, key);\n}\n","import {\n  BoxModel,\n  BoxModelOptions,\n  LookupFunction,\n  Record,\n  IVPIntegrator,\n} from './types';\n\nimport { rk4 } from './ode';\n\nimport { sum, hasOwnProperty } from './util';\n\ninterface LookupFunctionWithData extends LookupFunction {\n  data: (number | boolean)[];\n}\n\ntype FlowGetter = (\n  y: ReadonlyArray<number>,\n  x: number\n) => ReadonlyArray<number>;\n\nfunction throwLookupError(tableName: string, id: string) {\n  throw new Error(\n    `Value of unknown ${tableName} requested: ${id}. Check your box model definition.`\n  );\n}\n\ntype ConvergenceCriterion = (\n  r: Record,\n  rPrevious: Record,\n  i: number,\n  bme: BoxModelEngine\n) => boolean;\n\nexport default class BoxModelEngine {\n  public model: BoxModel;\n\n  public integrator: IVPIntegrator;\n\n  constructor(model: BoxModel, options: BoxModelOptions = { integrator: rk4 }) {\n    this.model = model;\n    this.integrator = options.integrator;\n  }\n\n  public static createIdToIdxMap(arr: ReadonlyArray<{ readonly id: string }>): {\n    [key: string]: number;\n  } {\n    return arr.reduce((acc: { [key: string]: number }, { id }, idx) => {\n      acc[id] = idx;\n      return acc;\n    }, {});\n  }\n\n  public evaluateGraph(stocks: ReadonlyArray<number>, t: number): Record {\n    const stockIdToIdx = BoxModelEngine.createIdToIdxMap(this.model.stocks);\n    const s: LookupFunction = (id) => {\n      if (!hasOwnProperty(stockIdToIdx, id)) throwLookupError('stock', id);\n      return stocks[stockIdToIdx[id]];\n    };\n\n    const parameterIdToIdx = BoxModelEngine.createIdToIdxMap(\n      this.model.parameters\n    );\n    const parameters = this.model.parameters.map(({ value }) => value);\n    const p: LookupFunction = (id) => {\n      if (!hasOwnProperty(parameterIdToIdx, id))\n        throwLookupError('parameter', id);\n      return parameters[parameterIdToIdx[id]];\n    };\n\n    const [f, v] = [\n      { items: this.model.flows, name: 'flow' },\n      { items: this.model.variables, name: 'variable' },\n    ].map(({ items, name }): LookupFunctionWithData => {\n      // build graph evaluator functions\n      const idToIdx = BoxModelEngine.createIdToIdxMap(items);\n      const data: (number | boolean)[] = items.map(() => false);\n      const evaluator = (id: string) => {\n        if (!hasOwnProperty(idToIdx, id)) throwLookupError(name, id);\n        const idx = idToIdx[id];\n        if (typeof data[idx] === 'boolean') {\n          // not initialized yet\n          if (data[idx]) {\n            throw new Error(`Evaluation cycle detected starting at: ${id}`);\n          } else {\n            data[idx] = true; // guard the element for cycle detection\n            data[idx] = items[idx].formula({ s, f, v, p, t });\n            return data[idx] as number;\n          }\n        } else {\n          return data[idx] as number;\n        }\n      };\n      evaluator.data = data;\n      return evaluator;\n    });\n\n    this.model.variables.forEach(({ id }) => v(id));\n    this.model.flows.forEach(({ id }) => f(id));\n\n    return {\n      stocks: stocks as number[],\n      flows: f.data as number[],\n      variables: v.data as number[],\n      parameters,\n      t,\n    };\n  }\n\n  public step(stocksAtT: ReadonlyArray<number>, t: number, h: number): number[];\n  public step(\n    stocksAtT: ReadonlyArray<number>,\n    flowsAtT: ReadonlyArray<number>,\n    t: number,\n    h: number\n  ): number[];\n  public step(\n    stocksAtT: ReadonlyArray<number>,\n    tOrFlowsAtT: ReadonlyArray<number> | number,\n    tOrH: number,\n    h?: number\n  ): number[] {\n    if (typeof tOrFlowsAtT === 'number')\n      return this.step3(stocksAtT, tOrFlowsAtT, tOrH);\n    if (typeof h !== 'undefined')\n      return this.step4(stocksAtT, tOrFlowsAtT, tOrH, h);\n    throw new TypeError();\n  }\n\n  private step3(\n    stocksAtT: ReadonlyArray<number>,\n    t: number,\n    h: number\n  ): number[] {\n    const getFlows: FlowGetter = (y, x) => this.evaluateGraph(y, x).flows;\n    return this.stepImpl(stocksAtT, getFlows, t, h);\n  }\n\n  private step4(\n    stocksAtT: ReadonlyArray<number>,\n    flowsAtT: ReadonlyArray<number>,\n    t: number,\n    h: number\n  ): number[] {\n    const getFlows: FlowGetter = (y, x) =>\n      x === t ? flowsAtT : this.evaluateGraph(y, x).flows;\n    return this.stepImpl(stocksAtT, getFlows, t, h);\n  }\n\n  protected stepImpl(\n    stocksAtT: ReadonlyArray<number>,\n    getFlows: FlowGetter,\n    t: number,\n    h: number\n  ): number[] {\n    const flowIdToIdx = BoxModelEngine.createIdToIdxMap(this.model.flows);\n\n    const derivatives = (y: ReadonlyArray<number>, x: number): number[] => {\n      const flows = getFlows(y, x);\n\n      const f: LookupFunction = (id): number => flows[flowIdToIdx[id]];\n      const addFlows = (flowIds: ReadonlyArray<string>) => sum(flowIds.map(f));\n\n      return this.model.stocks.map((s) => addFlows(s.in) - addFlows(s.out));\n    };\n\n    return this.integrator(stocksAtT, t, h, derivatives);\n  }\n\n  public stepExt(\n    stocksAtT: ReadonlyArray<number>,\n    t: number,\n    h: number\n  ): Record;\n  public stepExt(\n    stocksAtT: ReadonlyArray<number>,\n    flowsAtT: ReadonlyArray<number>,\n    t: number,\n    h: number\n  ): Record;\n  public stepExt(\n    stocksAtT: ReadonlyArray<number>,\n    tOrFlowsAtT: ReadonlyArray<number> | number,\n    tOrH: number,\n    h?: number\n  ): Record {\n    if (typeof tOrFlowsAtT === 'number')\n      return this.stepExt3(stocksAtT, tOrFlowsAtT, tOrH);\n    if (typeof h !== 'undefined')\n      return this.stepExt4(stocksAtT, tOrFlowsAtT, tOrH, h);\n    throw new TypeError();\n  }\n\n  private stepExt3(\n    stocksAtT: ReadonlyArray<number>,\n    t: number,\n    h: number\n  ): Record {\n    const stocks = this.step(stocksAtT, t, h);\n    return this.evaluateGraph(stocks, t + h);\n  }\n\n  private stepExt4(\n    stocksAtT: ReadonlyArray<number>,\n    flowsAtT: ReadonlyArray<number>,\n    t: number,\n    h: number\n  ): Record {\n    const stocks = this.step(stocksAtT, flowsAtT, t, h);\n    return this.evaluateGraph(stocks, t + h);\n  }\n\n  public converge(\n    stocksAtT: ReadonlyArray<number>,\n    t: number,\n    h: number,\n    criteria: ConvergenceCriterion\n  ): number[] {\n    return this.convergeExt(stocksAtT, t, h, criteria).stocks;\n  }\n\n  public convergeExt(\n    stocksAtT: ReadonlyArray<number>,\n    t: number,\n    h: number,\n    criterion: ConvergenceCriterion\n  ): Record {\n    let lastRecord = this.evaluateGraph(stocksAtT, t);\n    const getFlows: FlowGetter = (y, x) =>\n      x === lastRecord.t ? lastRecord.flows : this.evaluateGraph(y, x).flows;\n    for (let i = 0, stop = false; !stop; i += 1) {\n      const stocks = this.stepImpl(\n        lastRecord.stocks,\n        getFlows,\n        lastRecord.t,\n        h\n      );\n      const record = this.evaluateGraph(stocks, t + i * h);\n      stop = criterion(record, lastRecord, i, this);\n      lastRecord = record;\n    }\n    return lastRecord;\n  }\n}\n\nexport { BoxModelEngine, ConvergenceCriterion };\n"],"names":["rk4","y","x","h","derivatives","n","length","dydx","yTemp","Array","h2","h6","xhh","i","dydxTemp","dydxM","map","_","hasOwnPropertyFunc","Object","prototype","hasOwnProperty","o","key","call","throwLookupError","tableName","id","Error","model","options","integrator","this","createIdToIdxMap","arr","reduce","acc","idx","_ref","evaluateGraph","stocks","t","stockIdToIdx","BoxModelEngine","s","parameterIdToIdx","parameters","value","p","_map","items","flows","name","variables","_ref3","idToIdx","data","evaluator","formula","f","v","forEach","_ref4","_ref5","step","stocksAtT","tOrFlowsAtT","tOrH","step3","step4","TypeError","_this","stepImpl","flowsAtT","_this2","getFlows","_this3","flowIdToIdx","addFlows","flowIds","cur","out","stepExt","stepExt3","stepExt4","converge","criteria","convergeExt","criterion","_this4","lastRecord","stop","record","euler","yi"],"mappings":"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"}