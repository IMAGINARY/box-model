{"version":3,"file":"box-model.js","sources":["../src/ode.ts","../src/box-model.ts"],"sourcesContent":["export type IVPIntegrator = (\n  y: number[],\n  x: number,\n  h: number,\n  derivatives: (y: number[], x: number) => number[]\n) => number[];\n\nexport function euler(\n  y: number[],\n  x: number,\n  h: number,\n  derivatives: (y: number[], x: number) => number[]\n) {\n  const dydx = derivatives(y, x);\n  return y.map((_, i) => y[i] + h * dydx[i]);\n}\n\nexport function rk4(\n  y: number[],\n  x: number,\n  h: number,\n  derivatives: (y: number[], x: number) => number[]\n) {\n  const n: number = y.length;\n\n  const dydx = derivatives(y, x);\n  const yt: number[] = Array(n);\n\n  const hh = h / 2.0;\n  const h6 = h / 6.0;\n  const xhh = x + hh;\n\n  for (let i: number = 0; i < n; i += 1) yt[i] = y[i] + hh * dydx[i];\n  let dyt = derivatives(yt, xhh);\n\n  for (let i: number = 0; i < n; i += 1) yt[i] = y[i] + hh * dyt[i];\n  const dym = derivatives(yt, xhh);\n\n  for (let i: number = 0; i < n; i += 1) {\n    yt[i] = y[i] + h * dym[i];\n    dym[i] += dyt[i];\n  }\n  dyt = derivatives(yt, x + h);\n\n  return y.map((_, i) => y[i] + h6 * (dydx[i] + dyt[i] + 2.0 * dym[i]));\n}\n","import { IVPIntegrator, euler, rk4 } from './ode';\n\nexport { IVPIntegrator, euler, rk4 };\n\ntype LookupFunction = (id: string) => number;\n\nexport type Equation = (\n  s: LookupFunction,\n  f: LookupFunction,\n  v: LookupFunction,\n  c: LookupFunction,\n  t: number\n) => number;\n\nexport interface Stock {\n  readonly id: string;\n  readonly in: ReadonlyArray<string>;\n  readonly out: ReadonlyArray<string>;\n}\n\nexport interface Flow {\n  readonly id: string;\n  readonly equation: Equation;\n}\n\nexport interface Variable {\n  readonly id: string;\n  readonly equation: Equation;\n}\n\nexport interface Constant {\n  readonly id: string;\n  value: number;\n}\n\nexport interface Record {\n  stocks: number[];\n  flows: number[];\n  variables: number[];\n  constants: number[];\n  t: number;\n}\n\nfunction duplicates(arr: any[]) {\n  return arr.reduce((acc, cur, curIdx, arr) => {\n    if (arr.lastIndexOf(cur) !== curIdx) {\n      arr.push(cur);\n    }\n    return acc;\n  }, []);\n}\n\nfunction sum(a: Array<number>) {\n  return a.reduce((a, c) => a + c, 0);\n}\n\nexport default class BoxModel {\n  public readonly stocks: ReadonlyArray<Stock>;\n  public readonly flows: ReadonlyArray<Flow>;\n  public readonly variables: ReadonlyArray<Variable>;\n  public readonly constants: ReadonlyArray<Constant>;\n  public integrator: IVPIntegrator;\n\n  protected idToIdx: { [key: string]: number };\n\n  constructor(\n    {\n      stocks,\n      flows,\n      variables,\n      constants,\n    }: {\n      stocks: Stock[];\n      flows: Flow[];\n      variables: Variable[];\n      constants: Constant[];\n    },\n    integrator: IVPIntegrator = rk4\n  ) {\n    this.stocks = stocks;\n    this.flows = flows;\n    this.variables = variables;\n    this.constants = constants;\n    this.integrator = integrator;\n\n    this.ensureUniqueIds();\n\n    this.idToIdx = {\n      ...BoxModel.createIdToIdxMap(stocks),\n      ...BoxModel.createIdToIdxMap(variables),\n      ...BoxModel.createIdToIdxMap(constants),\n      ...BoxModel.createIdToIdxMap(flows),\n    };\n  }\n\n  protected ensureUniqueIds() {\n    const ids = []\n      .concat(this.stocks, this.variables, this.constants, this.flows)\n      .map((item) => item.id);\n    const duplicateIds = duplicates(ids);\n    if (duplicateIds.length > 0) {\n      throw new Error(`Duplicate ids found: ${duplicateIds}`);\n    }\n  }\n\n  static createIdToIdxMap(arr: Array<{ id: string }>) {\n    const map = {};\n    arr.forEach(({ id }, i) => (map[id] = i));\n    return map;\n  }\n\n  public evaluateGraph(stocks: number[], t: number): Record {\n    const s = (id) => stocks[this.idToIdx[id]];\n\n    const constants = this.constants.map(({ value }) => value);\n    const c = (id) => constants[this.idToIdx[id]];\n\n    const buildEvaluator = (items) => {\n      const data = new Array(items.length);\n      return {\n        evaluator: (id) => {\n          const idx = this.idToIdx[id];\n          if (data[idx] === null) {\n            throw new Error('Evaluation cycle detected starting at: ${id}');\n          }\n\n          if (typeof data[idx] === 'undefined') {\n            data[idx] = null; // guard the element for cycle detection\n            data[idx] = items[idx].equation(s, f, v, c, t);\n          }\n          return data[idx];\n        },\n        data,\n      };\n    };\n\n    const { evaluator: v, data: variables } = buildEvaluator(this.variables);\n    const { evaluator: f, data: flows } = buildEvaluator(this.flows);\n\n    this.variables.forEach(({ id }) => v(id));\n    this.flows.forEach(({ id }) => f(id));\n\n    return { stocks, flows, variables, constants, t };\n  }\n\n  public step(stocksAtT: number[], t: number, h: number): number[];\n  public step(\n    stocksAtT: number[],\n    flowsAtT: number[],\n    t: number,\n    h: number\n  ): number[];\n  public step(\n    stocksAtT: number[],\n    tOrFlowsAtT: number[] | number,\n    tOrH: number,\n    h?: number\n  ): number[] {\n    return typeof tOrFlowsAtT === 'number'\n      ? this.step3(stocksAtT, tOrFlowsAtT, tOrH)\n      : this.step4(stocksAtT, tOrFlowsAtT, tOrH, h);\n  }\n\n  private step3(stocksAtT: number[], t: number, h: number): number[] {\n    const getFlows = (y, x) => this.evaluateGraph(y, x).flows;\n    return this.stepImpl(stocksAtT, getFlows, t, h);\n  }\n\n  private step4(\n    stocksAtT: number[],\n    flowsAtT: number[],\n    t: number,\n    h: number\n  ): number[] {\n    const getFlows = (y, x) =>\n      x === t ? flowsAtT : this.evaluateGraph(y, x).flows;\n    return this.stepImpl(stocksAtT, getFlows, t, h);\n  }\n\n  protected stepImpl(\n    stocksAtT: number[],\n    getFlows: (y: number[], x: number) => number[],\n    t: number,\n    h: number\n  ): number[] {\n    const derivatives = (y: number[], x: number): number[] => {\n      const flows = getFlows(y, x);\n\n      const f = (id): number => flows[this.idToIdx[id]];\n      const addFlows = (flows) => sum(flows.map(f));\n\n      return this.stocks.map((s) => addFlows(s.in) - addFlows(s.out));\n    };\n\n    return this.integrator(stocksAtT, t, h, derivatives);\n  }\n\n  public stepExt(stocksAtT: number[], t: number, h: number): Record;\n  public stepExt(\n    stocksAtT: number[],\n    flowsAtT: number[],\n    t: number,\n    h: number\n  ): Record;\n  public stepExt(\n    stocksAtT: number[],\n    tOrFlowsAtT: number[] | number,\n    tOrH: number,\n    h?: number\n  ): Record {\n    return typeof tOrFlowsAtT === 'number'\n      ? this.stepExt3(stocksAtT, tOrFlowsAtT, tOrH)\n      : this.stepExt4(stocksAtT, tOrFlowsAtT, tOrH, h);\n  }\n\n  private stepExt3(stocksAtT: number[], t: number, h: number): Record {\n    const stocks = this.step(stocksAtT, t, h);\n    return { stocks, ...this.evaluateGraph(stocks, t + h) };\n  }\n\n  private stepExt4(\n    stocksAtT: number[],\n    flowsAtT: number[],\n    t: number,\n    h: number\n  ): Record {\n    const stocks = this.step(stocksAtT, flowsAtT, t, h);\n    return { stocks, ...this.evaluateGraph(stocks, t + h) };\n  }\n}\n\nexport { BoxModel };\n"],"names":["rk4","y","x","h","derivatives","n","length","dydx","yt","Array","hh","h6","xhh","i","dyt","dym","map","_","integrator","stocks","flows","variables","constants","this","ensureUniqueIds","idToIdx","BoxModel","createIdToIdxMap","duplicateIds","concat","item","id","reduce","acc","cur","curIdx","arr","lastIndexOf","push","Error","forEach","evaluateGraph","t","s","_this","value","c","buildEvaluator","items","data","evaluator","idx","equation","f","v","step","stocksAtT","tOrFlowsAtT","tOrH","step3","step4","stepImpl","_this2","flowsAtT","_this3","getFlows","_this4","addFlows","a","out","stepExt","stepExt3","stepExt4"],"mappings":"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"}