function t(t,r,e,n){for(var o=t.length,i=n(t,r),u=new Array(o),a=e/2,s=e/6,f=r+a,p=0;p<o;p+=1)u[p]=t[p]+a*i[p];for(var c=n(u,f),h=0;h<o;h+=1)u[h]=t[h]+a*c[h];for(var l=n(u,f),d=0;d<o;d+=1)u[d]=t[d]+e*l[d],l[d]+=c[d];return c=n(u,r+e),t.map(function(r,e){return t[e]+s*(i[e]+c[e]+2*l[e])})}exports.BoxModelEngine=function(){function r(r,e){void 0===e&&(e={integrator:t}),this.model=r,this.integrator=e.integrator}r.createIdToIdxMap=function(t){return t.reduce(function(t,r,e){return t[r.id]=e,t},{})};var e=r.prototype;return e.evaluateGraph=function(t,e){var n,o,i=r.createIdToIdxMap(this.model.stocks),u=function(r){return t[i[r]]},a=r.createIdToIdxMap(this.model.parameters),s=this.model.parameters.map(function(t){return t.value}),f=function(t){return s[a[t]]},p=function(t){var i=r.createIdToIdxMap(t),a=t.map(function(){return!1}),s=function(r){var s=i[r];if("boolean"==typeof a[s]){if(a[s])throw new Error("Evaluation cycle detected starting at: "+r);return a[s]=!0,a[s]=t[s].formula(u,n,o,f,e),a[s]}return a[s]};return s.data=a,s};return o=p(this.model.variables),n=p(this.model.flows),this.model.variables.forEach(function(t){return o(t.id)}),this.model.flows.forEach(function(t){return n(t.id)}),{stocks:t,flows:n.data,variables:o.data,parameters:s,t:e}},e.step=function(t,r,e,n){if("number"==typeof r)return this.step3(t,r,e);if(void 0!==n)return this.step4(t,r,e,n);throw new TypeError},e.step3=function(t,r,e){var n=this;return this.stepImpl(t,function(t,r){return n.evaluateGraph(t,r).flows},r,e)},e.step4=function(t,r,e,n){var o=this;return this.stepImpl(t,function(t,n){return n===e?r:o.evaluateGraph(t,n).flows},e,n)},e.stepImpl=function(t,e,n,o){var i=this,u=r.createIdToIdxMap(this.model.flows);return this.integrator(t,n,o,function(t,r){var n=e(t,r),o=function(t){return n[u[t]]},a=function(t){return t.map(o).reduce(function(t,r){return t+r},0)};return i.model.stocks.map(function(t){return a(t.in)-a(t.out)})})},e.stepExt=function(t,r,e,n){if("number"==typeof r)return this.stepExt3(t,r,e);if(void 0!==n)return this.stepExt4(t,r,e,n);throw new TypeError},e.stepExt3=function(t,r,e){var n=this.step(t,r,e);return this.evaluateGraph(n,r+e)},e.stepExt4=function(t,r,e,n){var o=this.step(t,r,e,n);return this.evaluateGraph(o,e+n)},r}(),exports.euler=function(t,r,e,n){var o=n(t,r);return t.map(function(t,r){return t+e*o[r]})},exports.rk4=t;
//# sourceMappingURL=box-model.js.map
