function t(t,r,e,n){for(var o=t.length,i=n(t,r),a=new Array(o),u=e/2,s=e/6,f=r+u,c=0;c<o;c+=1)a[c]=t[c]+u*i[c];for(var p=n(a,f),l=0;l<o;l+=1)a[l]=t[l]+u*p[l];for(var d=n(a,f),h=0;h<o;h+=1)a[h]=t[h]+e*d[h],d[h]+=p[h];return p=n(a,r+e),t.map(function(r,e){return t[e]+s*(i[e]+p[e]+2*d[e])})}var r=Object.prototype.hasOwnProperty;function e(t,e){return r.call(t,e)}function n(t,r){throw new Error("Value of unknown "+t+" requested: "+r+". Check your box model definition.")}exports.BoxModelEngine=/*#__PURE__*/function(){function r(r,e){void 0===e&&(e={integrator:t}),this.model=void 0,this.integrator=void 0,this.model=r,this.integrator=e.integrator}r.createIdToIdxMap=function(t){return t.reduce(function(t,r,e){return t[r.id]=e,t},{})};var o=r.prototype;return o.evaluateGraph=function(t,o){var i=r.createIdToIdxMap(this.model.stocks),a=function(r){return e(i,r)||n("stock",r),t[i[r]]},u=r.createIdToIdxMap(this.model.parameters),s=this.model.parameters.map(function(t){return t.value}),f=function(t){return e(u,t)||n("parameter",t),s[u[t]]},c=[{items:this.model.flows,name:"flow"},{items:this.model.variables,name:"variable"}].map(function(t){var i=t.items,u=t.name,s=r.createIdToIdxMap(i),c=i.map(function(){return!1}),d=function(t){e(s,t)||n(u,t);var r=s[t];if("boolean"==typeof c[r]){if(c[r])throw new Error("Evaluation cycle detected starting at: "+t);return c[r]=!0,c[r]=i[r].formula(a,p,l,f,o),c[r]}return c[r]};return d.data=c,d}),p=c[0],l=c[1];return this.model.variables.forEach(function(t){return l(t.id)}),this.model.flows.forEach(function(t){return p(t.id)}),{stocks:t,flows:p.data,variables:l.data,parameters:s,t:o}},o.step=function(t,r,e,n){if("number"==typeof r)return this.step3(t,r,e);if(void 0!==n)return this.step4(t,r,e,n);throw new TypeError},o.step3=function(t,r,e){var n=this;return this.stepImpl(t,function(t,r){return n.evaluateGraph(t,r).flows},r,e)},o.step4=function(t,r,e,n){var o=this;return this.stepImpl(t,function(t,n){return n===e?r:o.evaluateGraph(t,n).flows},e,n)},o.stepImpl=function(t,e,n,o){var i=this,a=r.createIdToIdxMap(this.model.flows);return this.integrator(t,n,o,function(t,r){var n=e(t,r),o=function(t){return n[a[t]]},u=function(t){return t.map(o).reduce(function(t,r){return t+r},0)};return i.model.stocks.map(function(t){return u(t.in)-u(t.out)})})},o.stepExt=function(t,r,e,n){if("number"==typeof r)return this.stepExt3(t,r,e);if(void 0!==n)return this.stepExt4(t,r,e,n);throw new TypeError},o.stepExt3=function(t,r,e){var n=this.step(t,r,e);return this.evaluateGraph(n,r+e)},o.stepExt4=function(t,r,e,n){var o=this.step(t,r,e,n);return this.evaluateGraph(o,e+n)},r}(),exports.euler=function(t,r,e,n){var o=n(t,r);return t.map(function(t,r){return t+e*o[r]})},exports.rk4=t;
//# sourceMappingURL=box-model.cjs.map
