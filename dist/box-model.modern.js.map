{"version":3,"file":"box-model.modern.js","sources":["../src/ode.ts","../src/util.ts","../src/box-model.ts"],"sourcesContent":["export function euler(\n  y: ReadonlyArray<number>,\n  x: number,\n  h: number,\n  derivatives: (y: ReadonlyArray<number>, x: number) => number[]\n): number[] {\n  const dydx = derivatives(y, x);\n  return y.map((yi, i) => yi + h * dydx[i]);\n}\n\nexport function rk4(\n  y: ReadonlyArray<number>,\n  x: number,\n  h: number,\n  derivatives: (y: ReadonlyArray<number>, x: number) => number[]\n): number[] {\n  const n: number = y.length;\n\n  const dydx = derivatives(y, x);\n  const yTemp: number[] = new Array(n) as number[];\n\n  const h2 = h / 2.0;\n  const h6 = h / 6.0;\n  const xhh = x + h2;\n\n  for (let i = 0; i < n; i += 1) yTemp[i] = y[i] + h2 * dydx[i];\n  let dydxTemp = derivatives(yTemp, xhh);\n\n  for (let i = 0; i < n; i += 1) yTemp[i] = y[i] + h2 * dydxTemp[i];\n  const dydxM = derivatives(yTemp, xhh);\n\n  for (let i = 0; i < n; i += 1) {\n    yTemp[i] = y[i] + h * dydxM[i];\n    dydxM[i] += dydxTemp[i];\n  }\n  dydxTemp = derivatives(yTemp, x + h);\n\n  return y.map((_, i) => y[i] + h6 * (dydx[i] + dydxTemp[i] + 2.0 * dydxM[i]));\n}\n","export function sum(arr: Array<number>): number {\n  return arr.reduce((acc, cur) => acc + cur, 0);\n}\n\n// eslint-disable-next-line @typescript-eslint/unbound-method\nconst hasOwnPropertyFunc = Object.prototype.hasOwnProperty;\nexport function hasOwnProperty(\n  o: Record<string, unknown>,\n  key: string\n): boolean {\n  return hasOwnPropertyFunc.call(o, key);\n}\n","import {\n  BoxModel,\n  BoxModelOptions,\n  LookupFunction,\n  Record,\n  IVPIntegrator,\n} from './types';\n\nimport { rk4 } from './ode';\n\nimport { sum, hasOwnProperty } from './util';\n\ninterface LookupFunctionWithData extends LookupFunction {\n  data: (number | boolean)[];\n}\n\ntype FlowGetter = (\n  y: ReadonlyArray<number>,\n  x: number\n) => ReadonlyArray<number>;\n\nfunction throwLookupError(tableName: string, id: string) {\n  throw new Error(\n    `Value of unknown ${tableName} requested: ${id}. Check your box model definition.`\n  );\n}\n\nexport default class BoxModelEngine {\n  public model: BoxModel;\n\n  public integrator: IVPIntegrator;\n\n  constructor(model: BoxModel, options: BoxModelOptions = { integrator: rk4 }) {\n    this.model = model;\n    this.integrator = options.integrator;\n  }\n\n  public static createIdToIdxMap(\n    arr: ReadonlyArray<{ readonly id: string }>\n  ): { [key: string]: number } {\n    return arr.reduce((acc: { [key: string]: number }, { id }, idx) => {\n      acc[id] = idx;\n      return acc;\n    }, {});\n  }\n\n  public evaluateGraph(stocks: ReadonlyArray<number>, t: number): Record {\n    const stockIdToIdx = BoxModelEngine.createIdToIdxMap(this.model.stocks);\n    const s: LookupFunction = (id) => {\n      if (!hasOwnProperty(stockIdToIdx, id)) throwLookupError('stock', id);\n      return stocks[stockIdToIdx[id]];\n    };\n\n    const parameterIdToIdx = BoxModelEngine.createIdToIdxMap(\n      this.model.parameters\n    );\n    const parameters = this.model.parameters.map(({ value }) => value);\n    const p: LookupFunction = (id) => {\n      if (!hasOwnProperty(parameterIdToIdx, id))\n        throwLookupError('parameter', id);\n      return parameters[parameterIdToIdx[id]];\n    };\n\n    const [f, v] = [\n      { items: this.model.flows, name: 'flow' },\n      { items: this.model.variables, name: 'variable' },\n    ].map(\n      ({ items, name }): LookupFunctionWithData => {\n        // build graph evaluator functions\n        const idToIdx = BoxModelEngine.createIdToIdxMap(items);\n        const data: (number | boolean)[] = items.map(() => false);\n        const evaluator = (id: string) => {\n          if (!hasOwnProperty(idToIdx, id)) throwLookupError(name, id);\n          const idx = idToIdx[id];\n          if (typeof data[idx] === 'boolean') {\n            // not initialized yet\n            if (data[idx]) {\n              throw new Error(`Evaluation cycle detected starting at: ${id}`);\n            } else {\n              data[idx] = true; // guard the element for cycle detection\n              data[idx] = items[idx].formula(s, f, v, p, t);\n              return data[idx] as number;\n            }\n          } else {\n            return data[idx] as number;\n          }\n        };\n        evaluator.data = data;\n        return evaluator;\n      }\n    );\n\n    this.model.variables.forEach(({ id }) => v(id));\n    this.model.flows.forEach(({ id }) => f(id));\n\n    return {\n      stocks: stocks as number[],\n      flows: f.data as number[],\n      variables: v.data as number[],\n      parameters,\n      t,\n    };\n  }\n\n  public step(stocksAtT: ReadonlyArray<number>, t: number, h: number): number[];\n  public step(\n    stocksAtT: ReadonlyArray<number>,\n    flowsAtT: ReadonlyArray<number>,\n    t: number,\n    h: number\n  ): number[];\n  public step(\n    stocksAtT: ReadonlyArray<number>,\n    tOrFlowsAtT: ReadonlyArray<number> | number,\n    tOrH: number,\n    h?: number\n  ): number[] {\n    if (typeof tOrFlowsAtT === 'number')\n      return this.step3(stocksAtT, tOrFlowsAtT, tOrH);\n    if (typeof h !== 'undefined')\n      return this.step4(stocksAtT, tOrFlowsAtT, tOrH, h);\n    throw new TypeError();\n  }\n\n  private step3(\n    stocksAtT: ReadonlyArray<number>,\n    t: number,\n    h: number\n  ): number[] {\n    const getFlows: FlowGetter = (y, x) => this.evaluateGraph(y, x).flows;\n    return this.stepImpl(stocksAtT, getFlows, t, h);\n  }\n\n  private step4(\n    stocksAtT: ReadonlyArray<number>,\n    flowsAtT: ReadonlyArray<number>,\n    t: number,\n    h: number\n  ): number[] {\n    const getFlows: FlowGetter = (y, x) =>\n      x === t ? flowsAtT : this.evaluateGraph(y, x).flows;\n    return this.stepImpl(stocksAtT, getFlows, t, h);\n  }\n\n  protected stepImpl(\n    stocksAtT: ReadonlyArray<number>,\n    getFlows: FlowGetter,\n    t: number,\n    h: number\n  ): number[] {\n    const flowIdToIdx = BoxModelEngine.createIdToIdxMap(this.model.flows);\n\n    const derivatives = (y: ReadonlyArray<number>, x: number): number[] => {\n      const flows = getFlows(y, x);\n\n      const f: LookupFunction = (id): number => flows[flowIdToIdx[id]];\n      const addFlows = (flowIds: ReadonlyArray<string>) => sum(flowIds.map(f));\n\n      return this.model.stocks.map((s) => addFlows(s.in) - addFlows(s.out));\n    };\n\n    return this.integrator(stocksAtT, t, h, derivatives);\n  }\n\n  public stepExt(\n    stocksAtT: ReadonlyArray<number>,\n    t: number,\n    h: number\n  ): Record;\n  public stepExt(\n    stocksAtT: ReadonlyArray<number>,\n    flowsAtT: ReadonlyArray<number>,\n    t: number,\n    h: number\n  ): Record;\n  public stepExt(\n    stocksAtT: ReadonlyArray<number>,\n    tOrFlowsAtT: ReadonlyArray<number> | number,\n    tOrH: number,\n    h?: number\n  ): Record {\n    if (typeof tOrFlowsAtT === 'number')\n      return this.stepExt3(stocksAtT, tOrFlowsAtT, tOrH);\n    if (typeof h !== 'undefined')\n      return this.stepExt4(stocksAtT, tOrFlowsAtT, tOrH, h);\n    throw new TypeError();\n  }\n\n  private stepExt3(\n    stocksAtT: ReadonlyArray<number>,\n    t: number,\n    h: number\n  ): Record {\n    const stocks = this.step(stocksAtT, t, h);\n    return this.evaluateGraph(stocks, t + h);\n  }\n\n  private stepExt4(\n    stocksAtT: ReadonlyArray<number>,\n    flowsAtT: ReadonlyArray<number>,\n    t: number,\n    h: number\n  ): Record {\n    const stocks = this.step(stocksAtT, flowsAtT, t, h);\n    return this.evaluateGraph(stocks, t + h);\n  }\n}\n\nexport { BoxModelEngine };\n"],"names":["euler","y","x","h","derivatives","dydx","map","yi","i","rk4","n","length","yTemp","Array","h2","h6","xhh","dydxTemp","dydxM","_","hasOwnPropertyFunc","Object","prototype","hasOwnProperty","o","key","call","throwLookupError","tableName","id","Error","BoxModelEngine","constructor","model","options","integrator","this","static","arr","reduce","acc","idx","evaluateGraph","stocks","t","stockIdToIdx","createIdToIdxMap","s","parameterIdToIdx","parameters","value","p","f","v","items","flows","name","variables","idToIdx","data","evaluator","formula","forEach","step","stocksAtT","tOrFlowsAtT","tOrH","step3","step4","TypeError","stepImpl","flowsAtT","getFlows","flowIdToIdx","addFlows","flowIds","cur","in","out","stepExt","stepExt3","stepExt4"],"mappings":"AAAgBA,SAAAA,EACdC,EACAC,EACAC,EACAC,GAEA,MAAMC,EAAOD,EAAYH,EAAGC,GAC5B,OAAOD,EAAEK,IAAI,CAACC,EAAIC,IAAMD,EAAKJ,EAAIE,EAAKG,IAGlC,SAAUC,EACdR,EACAC,EACAC,EACAC,GAEA,MAAMM,EAAYT,EAAEU,OAEdN,EAAOD,EAAYH,EAAGC,GACtBU,EAAkB,IAAIC,MAAMH,GAE5BI,EAAKX,EAAI,EACTY,EAAKZ,EAAI,EACTa,EAAMd,EAAIY,EAEhB,IAAK,IAAIN,EAAI,EAAGA,EAAIE,EAAGF,GAAK,EAAGI,EAAMJ,GAAKP,EAAEO,GAAKM,EAAKT,EAAKG,GAC3D,IAAIS,EAAWb,EAAYQ,EAAOI,GAElC,IAAK,IAAIR,EAAI,EAAGA,EAAIE,EAAGF,GAAK,EAAGI,EAAMJ,GAAKP,EAAEO,GAAKM,EAAKG,EAAST,GAC/D,MAAMU,EAAQd,EAAYQ,EAAOI,GAEjC,IAAK,IAAIR,EAAI,EAAGA,EAAIE,EAAGF,GAAK,EAC1BI,EAAMJ,GAAKP,EAAEO,GAAKL,EAAIe,EAAMV,GAC5BU,EAAMV,IAAMS,EAAST,GAIvB,OAFAS,EAAWb,EAAYQ,EAAOV,EAAIC,GAE3BF,EAAEK,IAAI,CAACa,EAAGX,IAAMP,EAAEO,GAAKO,GAAMV,EAAKG,GAAKS,EAAST,GAAK,EAAMU,EAAMV,KChC1E,MAAMY,EAAqBC,OAAOC,UAAUC,eAC5B,SAAAA,EACdC,EACAC,GAEA,OAAOL,EAAmBM,KAAKF,EAAGC,GCWpC,SAASE,EAAiBC,EAAmBC,GAC3C,MAAM,IAAIC,MACR,oBAAoBF,gBAAwBC,uCAI3BE,MAAAA,EAKnBC,YAAYC,EAAiBC,EAA2B,CAAEC,WAAY1B,IAJ/DwB,KAAAA,kBAEAE,gBAEoE,EACzEC,KAAKH,MAAQA,EACbG,KAAKD,WAAaD,EAAQC,WAGEE,wBAC5BC,GAEA,OAAOA,EAAIC,OAAO,CAACC,GAAkCX,GAAAA,GAAMY,KACzDD,EAAIX,GAAMY,EACHD,GACN,IAGEE,cAAcC,EAA+BC,GAClD,MAAMC,EAAed,EAAee,iBAAiBV,KAAKH,MAAMU,QAC1DI,EAAqBlB,IACpBN,EAAesB,EAAchB,IAAKF,EAAiB,QAASE,GAC1Dc,EAAOE,EAAahB,KAGvBmB,EAAmBjB,EAAee,iBACtCV,KAAKH,MAAMgB,YAEPA,EAAab,KAAKH,MAAMgB,WAAW3C,IAAI,EAAG4C,MAAAA,KAAYA,GACtDC,EAAqBtB,IACpBN,EAAeyB,EAAkBnB,IACpCF,EAAiB,YAAaE,GACzBoB,EAAWD,EAAiBnB,MAG9BuB,EAAGC,GAAK,CACb,CAAEC,MAAOlB,KAAKH,MAAMsB,MAAOC,KAAM,QACjC,CAAEF,MAAOlB,KAAKH,MAAMwB,UAAWD,KAAM,aACrClD,IACA,EAAGgD,MAAAA,EAAOE,KAAAA,MAER,MAAME,EAAU3B,EAAee,iBAAiBQ,GAC1CK,EAA6BL,EAAMhD,IAAI,KAAM,GAC7CsD,EAAa/B,IACZN,EAAemC,EAAS7B,IAAKF,EAAiB6B,EAAM3B,GACzD,MAAMY,EAAMiB,EAAQ7B,GACpB,GAAyB,kBAAd8B,EAAKlB,GAAoB,CAElC,GAAIkB,EAAKlB,GACP,MAAUX,IAAAA,gDAAgDD,KAI1D,OAFA8B,EAAKlB,IAAO,EACZkB,EAAKlB,GAAOa,EAAMb,GAAKoB,QAAQd,EAAGK,EAAGC,EAAGF,EAAGP,GACpCe,EAAKlB,GAGd,OAAOkB,EAAKlB,IAIhB,OADAmB,EAAUD,KAAOA,EACVC,IAOX,OAHAxB,KAAKH,MAAMwB,UAAUK,QAAQ,EAAGjC,GAAAA,KAASwB,EAAExB,IAC3CO,KAAKH,MAAMsB,MAAMO,QAAQ,EAAGjC,GAAAA,KAASuB,EAAEvB,IAEhC,CACLc,OAAQA,EACRY,MAAOH,EAAEO,KACTF,UAAWJ,EAAEM,KACbV,WAAAA,EACAL,EAAAA,GAWGmB,KACLC,EACAC,EACAC,EACA/D,GAEA,GAA2B,iBAAhB8D,EACT,OAAO7B,KAAK+B,MAAMH,EAAWC,EAAaC,GAC5C,QAAiB,IAAN/D,EACT,OAAYiE,KAAAA,MAAMJ,EAAWC,EAAaC,EAAM/D,GAClD,MAAUkE,IAAAA,UAGJF,MACNH,EACApB,EACAzC,GAGA,OAAOiC,KAAKkC,SAASN,EADQ,CAAC/D,EAAGC,IAAMkC,KAAKM,cAAczC,EAAGC,GAAGqD,MACtBX,EAAGzC,GAGvCiE,MACNJ,EACAO,EACA3B,EACAzC,GAIA,YAAYmE,SAASN,EAFQ,CAAC/D,EAAGC,IAC/BA,IAAM0C,EAAI2B,EAAWnC,KAAKM,cAAczC,EAAGC,GAAGqD,MACNX,EAAGzC,GAGrCmE,SACRN,EACAQ,EACA5B,EACAzC,GAEA,MAAMsE,EAAc1C,EAAee,iBAAiBV,KAAKH,MAAMsB,OAW/D,YAAYpB,WAAW6B,EAAWpB,EAAGzC,EATjB,CAACF,EAA0BC,KAC7C,MAAMqD,EAAQiB,EAASvE,EAAGC,GAEpBkD,EAAqBvB,GAAe0B,EAAMkB,EAAY5C,IACtD6C,EAAYC,GAAuCA,EAAQrE,IAAI8C,GD3J9Db,OAAO,CAACC,EAAKoC,IAAQpC,EAAMoC,EAAK,GC6JvC,OAAY3C,KAAAA,MAAMU,OAAOrC,IAAKyC,GAAM2B,EAAS3B,EAAE8B,IAAMH,EAAS3B,EAAE+B,QAiB7DC,QACLf,EACAC,EACAC,EACA/D,GAEA,GAA2B,iBAAhB8D,EACT,OAAO7B,KAAK4C,SAAShB,EAAWC,EAAaC,GAC/C,QAAiB,IAAN/D,EACT,OAAOiC,KAAK6C,SAASjB,EAAWC,EAAaC,EAAM/D,GACrD,MAAUkE,IAAAA,UAGJW,SACNhB,EACApB,EACAzC,GAEA,MAAMwC,EAASP,KAAK2B,KAAKC,EAAWpB,EAAGzC,GACvC,OAAOiC,KAAKM,cAAcC,EAAQC,EAAIzC,GAGhC8E,SACNjB,EACAO,EACA3B,EACAzC,GAEA,MAAMwC,EAASP,KAAK2B,KAAKC,EAAWO,EAAU3B,EAAGzC,GACjD,YAAYuC,cAAcC,EAAQC,EAAIzC"}